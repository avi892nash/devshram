name: Release and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  S3_BUCKET: devshram.com
  CLOUDFRONT_DISTRIBUTION_ID: E2RU8A6DN1OCFF
  NODE_ENV: production

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

jobs:
  build-release-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: 0

      - name: Build project
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "./.next" ]; then
            echo "âŒ SSR build output directory (.next) not found!"
            exit 1
          fi
          echo "âœ… Build successful"

      - name: Run semantic-release
        id: semantic
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Deploying version: ${VERSION}"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::532197675314:role/github_actions_devshram
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BASE_PATH="s3://${{ env.S3_BUCKET }}/devshram/v${VERSION}"

          echo "ðŸš€ Deploying version ${VERSION} to ${BASE_PATH}"

          # Upload .next directory as _next with long-term caching
          aws s3 sync ./.next ${BASE_PATH}/_next \
            --cache-control "public,max-age=31536000,immutable"

          # Upload public folder with long-term caching
          if [ -d "./public" ]; then
            aws s3 sync ./public ${BASE_PATH}/public \
              --cache-control "public,max-age=31536000,immutable"
          fi

          echo "âœ… Successfully deployed version ${VERSION}"

