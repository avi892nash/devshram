name: Release and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  S3_BUCKET: devshram.com
  CLOUDFRONT_DISTRIBUTION_ID: E2RU8A6DN1OCFF
  NODE_ENV: production

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

jobs:
  build-release-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: 0

      - name: Build project
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "./.next" ]; then
            echo "âŒ SSR build output directory (.next) not found!"
            exit 1
          fi
          echo "âœ… Build successful"

      - name: Run semantic-release
        id: semantic
        if: github.event_name == 'push'
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: ${VERSION}"

      - name: Create SSR artifact
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          ARTIFACT_NAME="devshram-ssr-v${VERSION}.tar.gz"

          echo "ðŸ“¦ Creating SSR artifact: ${ARTIFACT_NAME}"

          # Make start script executable
          chmod +x start-server.sh

          # Create artifact with necessary SSR files
          tar -czf ${ARTIFACT_NAME} \
            .next \
            package.json \
            package-lock.json \
            public \
            start-server.sh \
            DEPLOYMENT.md

          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          echo "âœ… Artifact created: ${ARTIFACT_NAME}"
          ls -lh ${ARTIFACT_NAME}

      - name: Upload SSR artifact to release
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          ARTIFACT_NAME="${{ env.ARTIFACT_NAME }}"

          echo "ðŸ“¤ Uploading ${ARTIFACT_NAME} to release v${VERSION}"

          gh release upload "v${VERSION}" "${ARTIFACT_NAME}" \
            --clobber \
            --repo ${{ github.repository }}

          echo "âœ… Artifact uploaded to release"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::532197675314:role/github_actions_devshram
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          BASE_PATH="s3://${{ env.S3_BUCKET }}/devshram"

          echo "ðŸš€ Deploying to ${BASE_PATH}"

          # Upload .next/static directory to _next/static with long-term caching
          aws s3 sync ./.next/static ${BASE_PATH}/_next/static \
            --cache-control "public,max-age=31536000,immutable"

          # Upload public folder with long-term caching
          if [ -d "./public" ]; then
            aws s3 sync ./public ${BASE_PATH}/public \
              --cache-control "public,max-age=31536000,immutable"
          fi

          echo "âœ… Successfully deployed to S3"

